---
import { getCollection } from 'astro:content'
import BaseLayout from '@/layouts/BaseLayout.astro'

// Get all published blog posts, sorted by date (newest first)
const allPosts = (await getCollection('blog'))
  .filter(post => !post.data.draft)
  .sort((a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf())

// Group posts by year
const postsByYear = allPosts.reduce((acc, post) => {
  const year = new Date(post.data.publishDate).getFullYear()
  if (!acc[year]) acc[year] = []
  acc[year].push(post)
  return acc
}, {} as Record<number, typeof allPosts>)

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a)
---

<BaseLayout
  title="Journal"
  description="Latest thoughts on stablecoins, tokenization, AGI, investment strategies, and global systemic challenges."
>
  <div class="eink-wrap py-[clamp(1.25rem,3vw,2.5rem)]">
    <!-- Header -->
    <header class="mb-10 lg:mb-12">
      <h1 class="eink-hero-title font-serif">Journal</h1>
      <p class="eink-hero-copy">
        {allPosts.length} posts on stablecoins, tokenization, AGI, and more.
      </p>
      <div class="eink-ui mt-4 flex items-center gap-6 text-sm">
        <a 
          href="/archive" 
          class="text-muted-foreground hover:text-foreground transition-colors"
        >
          Browse by category â†’
        </a>
        <a 
          href="/rss.xml" 
          class="text-muted-foreground hover:text-foreground transition-colors"
        >
          RSS
        </a>
      </div>
    </header>

    <!-- Posts by Year -->
    <div class="space-y-5">
      {years.map(year => (
        <section class="eink-card">
          <h2 class="eink-ui text-sm font-medium uppercase tracking-wider text-muted-foreground mb-4">
            {year}
          </h2>
          <ul class="space-y-2">
            {postsByYear[year].map(post => (
              <li>
                <a 
                  href={`/journal/${post.slug}/`}
                  class="group flex flex-col gap-1 rounded-md px-2 py-1 transition-colors hover:bg-muted/50 sm:flex-row sm:items-baseline sm:justify-between"
                >
                  <span class="text-foreground group-hover:underline decoration-1 underline-offset-2 flex-1">
                    {post.data.title}
                  </span>
                  <span class="eink-meta shrink-0 tabular-nums">
                    {new Date(post.data.publishDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                  </span>
                </a>
              </li>
            ))}
          </ul>
        </section>
      ))}
    </div>

    <!-- Empty State -->
    {allPosts.length === 0 && (
      <div class="text-center py-12">
        <p class="text-lg text-muted-foreground mb-4">No posts found.</p>
        <p class="text-sm text-muted-foreground">
          Content is being migrated. Check back soon!
        </p>
      </div>
    )}
  </div>
</BaseLayout>
