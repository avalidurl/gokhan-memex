---
import { type CollectionEntry, getCollection } from 'astro:content'
import BaseLayout from '@/layouts/BaseLayout.astro'

export async function getStaticPaths() {
  const posts = await getCollection('blog')
  const publishedPosts = posts.filter(post => !post.data.draft)
  
  // Get unique year-month combinations
  const yearMonthSet = new Set<string>()
  publishedPosts.forEach(post => {
    const date = new Date(post.data.publishDate)
    const year = date.getFullYear()
    const month = (date.getMonth() + 1).toString().padStart(2, '0')
    yearMonthSet.add(`${year}-${month}`)
  })
  
  return Array.from(yearMonthSet).map((yearMonth: string) => {
    const [year, month] = yearMonth.split('-') as [string, string]
    return {
      params: { 
        year: year,
        month: month
      },
      props: { 
        year: parseInt(year, 10),
        month: parseInt(month, 10),
        posts: publishedPosts
      }
    }
  })
}

interface Props {
  year: number
  month: number
  posts: CollectionEntry<'blog'>[]
}

const { year, month, posts } = Astro.props

// Filter posts for this year and month
const monthPosts = posts.filter(post => {
  const date = new Date(post.data.publishDate)
  return date.getFullYear() === year && (date.getMonth() + 1) === month
}).sort((a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf())

const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                   'July', 'August', 'September', 'October', 'November', 'December']

const monthName = monthNames[month - 1]
---

<BaseLayout
  title={`${monthName} ${year}`}
  description={`${monthPosts.length} posts published in ${monthName} ${year}`}
  robots="noindex, follow"
>
  <div class="mx-auto max-w-2xl px-6 py-12 lg:py-16">
    <!-- Header -->
    <header class="mb-12">
      <h1 class="text-3xl font-semibold tracking-tight mb-4">{monthName} {year}</h1>
      <p class="text-muted-foreground">
        {monthPosts.length} post{monthPosts.length !== 1 ? 's' : ''} published
      </p>
    </header>

    {monthPosts.length > 0 ? (
      <ul class="space-y-3">
        {monthPosts.map(post => (
          <li>
            <a 
              href={`/journal/${post.slug}/`}
              class="group block"
            >
              <span class="text-foreground group-hover:underline decoration-1 underline-offset-2">
                {post.data.title}
              </span>
              <span class="block text-sm text-muted-foreground mt-0.5">
                {post.data.description}
              </span>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-muted-foreground">No posts found for {monthName} {year}.</p>
    )}

    <!-- Navigation -->
    <footer class="mt-12 pt-8 border-t border-border">
      <div class="flex justify-between">
        <a 
          href={`/journal/${year}/`}
          class="text-sm text-muted-foreground hover:text-foreground transition-colors"
        >
          ‚Üê {year}
        </a>
        <a 
          href="/archive"
          class="text-sm text-muted-foreground hover:text-foreground transition-colors"
        >
          Archive
        </a>
      </div>
    </footer>
  </div>
</BaseLayout>
