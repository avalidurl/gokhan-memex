---
import { type CollectionEntry, getCollection } from 'astro:content'
import BaseLayout from '@/layouts/BaseLayout.astro'

export async function getStaticPaths() {
  const posts = await getCollection('blog')
  const publishedPosts = posts.filter(post => !post.data.draft)
  
  // Get unique years
  const years = [...new Set(publishedPosts.map(post => 
    new Date(post.data.publishDate).getFullYear()
  ))]
  
  return years.map(year => ({
    params: { year: year.toString() },
    props: { year, posts: publishedPosts }
  }))
}

interface Props {
  year: number
  posts: CollectionEntry<'blog'>[]
}

const { year, posts } = Astro.props

// Filter posts for this year and group by month
const yearPosts = posts.filter(post => 
  new Date(post.data.publishDate).getFullYear() === year
).sort((a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf())

const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                   'July', 'August', 'September', 'October', 'November', 'December']

type PostType = CollectionEntry<'blog'>
const postsByMonth = new Map<number, PostType[]>()
yearPosts.forEach(post => {
  const month = new Date(post.data.publishDate).getMonth()
  if (postsByMonth.has(month)) {
    postsByMonth.get(month)?.push(post)
  } else {
    postsByMonth.set(month, [post])
  }
})

// Sort months in descending order (most recent first)
const sortedMonths: [number, PostType[]][] = Array.from(postsByMonth.entries()).sort((a, b) => b[0] - a[0])
---

<BaseLayout
  title={`${year}`}
  description={`${yearPosts.length} posts published in ${year}`}
  robots="noindex, follow"
>
  <div class="mx-auto max-w-2xl px-6 py-12 lg:py-16">
    <!-- Header -->
    <header class="mb-12">
      <h1 class="text-3xl font-semibold tracking-tight mb-4">{year}</h1>
      <p class="text-muted-foreground">
        {yearPosts.length} post{yearPosts.length !== 1 ? 's' : ''} published
      </p>
    </header>

    {yearPosts.length > 0 ? (
      <div class="space-y-12">
        {sortedMonths.map(([monthIndex, monthPosts]) => (
          <section>
            <h2 class="text-sm font-medium uppercase tracking-wider text-muted-foreground mb-4">
              {monthNames[monthIndex]}
            </h2>
            <ul class="space-y-2">
              {monthPosts.map(post => (
                <li>
                  <a 
                    href={`/journal/${post.slug}/`}
                    class="group flex items-baseline gap-3 py-1"
                  >
                    <span class="text-foreground group-hover:underline decoration-1 underline-offset-2">
                      {post.data.title}
                    </span>
                    <span class="text-sm text-muted-foreground shrink-0">
                      {new Date(post.data.publishDate).getDate()}
                    </span>
                  </a>
                </li>
              ))}
            </ul>
          </section>
        ))}
      </div>
    ) : (
      <p class="text-muted-foreground">No posts found for {year}.</p>
    )}

    <!-- Navigation -->
    <footer class="mt-12 pt-8 border-t border-border">
      <a 
        href="/archive"
        class="text-sm text-muted-foreground hover:text-foreground transition-colors"
      >
        ‚Üê Back to Archive
      </a>
    </footer>
  </div>
</BaseLayout>
