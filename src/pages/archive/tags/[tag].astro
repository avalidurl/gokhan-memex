---
import { getCollection, type CollectionEntry } from 'astro:content'
import type { GetStaticPaths } from 'astro'
import BaseLayout from '@/layouts/BaseLayout.astro'

type PostEntry = CollectionEntry<'blog'>

export const getStaticPaths: GetStaticPaths = async () => {
  const allPosts = (await getCollection('blog'))
    .filter((post: PostEntry) => !post.data.draft)

  const tagSet = new Set<string>()
  allPosts.forEach((post: PostEntry) => {
    post.data.tags?.forEach((tag: string) => {
      tagSet.add(tag)
    })
  })

  return Array.from(tagSet).map((tag: string) => ({
    params: {
      tag: tag.toLowerCase().replace(/\s+/g, '-')
    }
  }))
}

const { tag: tagSlug } = Astro.params as { tag: string }

const allPosts = (await getCollection('blog'))
  .filter((post: PostEntry) => !post.data.draft)

const tagMap = new Map<string, string>()
allPosts.forEach((post: PostEntry) => {
  post.data.tags?.forEach((tag: string) => {
    const slug = tag.toLowerCase().replace(/\s+/g, '-')
    tagMap.set(slug, tag)
  })
})

const tag = tagMap.get(tagSlug) || tagSlug

const posts: PostEntry[] = allPosts
  .filter((post: PostEntry) => post.data.tags?.some((t: string) =>
    t.toLowerCase().replace(/\s+/g, '-') === tagSlug
  ))
  .sort((a: PostEntry, b: PostEntry) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf())
---

<BaseLayout
  title={`${tag} - Archive`}
  description={`${posts.length} posts tagged with ${tag}.`}
  robots="noindex, follow"
>
  <div class="mx-auto max-w-2xl px-6 py-12 lg:py-16">
    <header class="mb-12">
      <p class="text-sm text-muted-foreground mb-2">
        <a href="/archive" class="hover:underline underline-offset-2">Archive</a> / Tags
      </p>
      <h1 class="text-3xl font-semibold tracking-tight mb-2">{tag}</h1>
      <p class="text-muted-foreground">
        {posts.length} post{posts.length !== 1 ? 's' : ''}
      </p>
    </header>

    {posts.length > 0 ? (
      <ul class="space-y-2">
        {posts.map((post: PostEntry) => (
          <li>
            <a 
              href={`/journal/${post.slug}/`}
              class="group flex items-baseline gap-3 py-1"
            >
              <span class="text-foreground group-hover:underline decoration-1 underline-offset-2">
                {post.data.title}
              </span>
              <span class="text-sm text-muted-foreground shrink-0">
                {post.data.publishDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}
              </span>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-muted-foreground">No posts with this tag.</p>
    )}

    <div class="mt-12 pt-8 border-t border-border">
      <a 
        href="/archive"
        class="text-muted-foreground hover:text-foreground hover:underline underline-offset-2"
      >
        ‚Üê Back to archive
      </a>
    </div>
  </div>
</BaseLayout>
