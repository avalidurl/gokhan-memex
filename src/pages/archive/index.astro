---
import { getCollection } from 'astro:content'
import BaseLayout from '@/layouts/BaseLayout.astro'

// Get all published blog posts
const allPosts = (await getCollection('blog'))
  .filter(post => !post.data.draft)
  .sort((a, b) => new Date(b.data.publishDate).valueOf() - new Date(a.data.publishDate).valueOf())

// Extract categories and their counts
const categoryMap = new Map<string, number>()
allPosts.forEach(post => {
  const category = post.data.category
  categoryMap.set(category, (categoryMap.get(category) ?? 0) + 1)
})

// Extract tags and their counts
const tagMap = new Map<string, number>()
allPosts.forEach(post => {
  post.data.tags?.forEach(tag => {
    tagMap.set(tag, (tagMap.get(tag) ?? 0) + 1)
  })
})

// Sort categories by count (descending) and tags by count
const sortedCategories = Array.from(categoryMap.entries()).sort((a, b) => b[1] - a[1])
const sortedTags = Array.from(tagMap.entries()).sort((a, b) => b[1] - a[1])

// Group posts by year
const postsByYear = new Map<number, typeof allPosts>()
allPosts.forEach(post => {
  const year = new Date(post.data.publishDate).getFullYear()
  if (!postsByYear.has(year)) postsByYear.set(year, [])
  postsByYear.get(year)?.push(post)
})
const sortedYears = Array.from(postsByYear.keys()).sort((a, b) => b - a)
---

<BaseLayout
  title="Archive"
  description="Browse all content by categories, tags, and years."
  robots="noindex, follow"
>
  <div class="mx-auto max-w-2xl px-6 py-12 lg:py-16">
    <!-- Header -->
    <header class="mb-12">
      <h1 class="text-3xl font-semibold tracking-tight mb-4">Archive</h1>
      <p class="text-muted-foreground">
        {allPosts.length} posts across {sortedCategories.length} categories and {sortedTags.length} tags.
      </p>
    </header>

    <div class="space-y-12">
      <!-- Categories Section -->
      <section id="categories">
        <h2 class="text-sm font-medium uppercase tracking-wider text-muted-foreground mb-4">
          Categories
        </h2>
        <ul class="space-y-1">
          {sortedCategories.map(([category, count]) => (
            <li>
              <a 
                href={`/archive/categories/${category.toLowerCase().replace(/\s+/g, '-').replace(/&/g, 'and')}`}
                class="group flex items-baseline justify-between py-2"
              >
                <span class="text-foreground group-hover:underline decoration-1 underline-offset-2">
                  {category}
                </span>
                <span class="text-sm text-muted-foreground tabular-nums">
                  {count}
                </span>
              </a>
            </li>
          ))}
        </ul>
      </section>

      <!-- Tags Section -->
      <section id="tags">
        <h2 class="text-sm font-medium uppercase tracking-wider text-muted-foreground mb-4">
          Tags
        </h2>
        <div class="flex flex-wrap gap-2">
          {sortedTags.slice(0, 40).map(([tag, count]) => (
            <a 
              href={`/archive/tags/${tag.toLowerCase().replace(/\s+/g, '-')}`}
              class="text-sm text-muted-foreground hover:text-foreground transition-colors"
            >
              #{tag} <span class="text-xs opacity-60">({count})</span>
            </a>
          ))}
          {sortedTags.length > 40 && (
            <a 
              href="/archive/tags"
              class="text-sm text-muted-foreground hover:text-foreground transition-colors"
            >
              +{sortedTags.length - 40} more
            </a>
          )}
        </div>
      </section>

      <!-- Years Section -->
      <section id="years">
        <h2 class="text-sm font-medium uppercase tracking-wider text-muted-foreground mb-4">
          Years
        </h2>
        <ul class="space-y-1">
          {sortedYears.map(year => (
            <li>
              <a 
                href={`/journal/${year}`}
                class="group flex items-baseline justify-between py-2"
              >
                <span class="text-foreground group-hover:underline decoration-1 underline-offset-2">
                  {year}
                </span>
                <span class="text-sm text-muted-foreground tabular-nums">
                  {postsByYear.get(year)?.length} posts
                </span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    </div>
  </div>
</BaseLayout>
