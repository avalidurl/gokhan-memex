---
interface Props {
  url: string
  width?: string | number
  height?: string | number
  trackId?: string
  albumId?: string
  size?: 'large' | 'small'
  artwork?: 'small' | 'big'
  transparent?: boolean
}

const { 
  url, 
  width = '100%', 
  height = 'auto',
  size = 'large',
  artwork = 'small',
  transparent = true
} = Astro.props

// Check if URL is already a Bandcamp embed URL or extract info from regular URLs
function processBandcampUrl(url: string): { embedUrl: string, isValid: boolean } {
  try {
    // If URL is already a Bandcamp embed URL, use it directly
    if (url.includes('bandcamp.com/EmbeddedPlayer/')) {
      return { embedUrl: url, isValid: true }
    }
    
    // If it's a regular Bandcamp URL, try to extract info
    const urlObj = new URL(url)
    const pathParts = urlObj.pathname.split('/')
    
    let type: 'track' | 'album' | null = null
    let id: string | null = null
    
    if (pathParts.includes('track') && pathParts[pathParts.indexOf('track') + 1]) {
      type = 'track'
      id = pathParts[pathParts.indexOf('track') + 1]
    } else if (pathParts.includes('album') && pathParts[pathParts.indexOf('album') + 1]) {
      type = 'album' 
      id = pathParts[pathParts.indexOf('album') + 1]
    }
    
    if (type && id) {
      const embedUrl = `https://bandcamp.com/EmbeddedPlayer/${type}=${id}/size=${size}/bgcol=ffffff/linkcol=0687f5/artwork=${artwork}/transparent=${transparent}/`
      return { embedUrl, isValid: true }
    }
    
    return { embedUrl: '', isValid: false }
  } catch {
    return { embedUrl: '', isValid: false }
  }
}

const { embedUrl, isValid } = processBandcampUrl(url)
const embedHeight = size === 'large' ? '472' : '120'
---

<div class="my-6 not-prose">
  <div class="rounded-lg overflow-hidden border bg-card">
    {isValid ? (
      <iframe 
        style={`border: 0; width: ${width}; height: ${embedHeight}px;`}
        src={embedUrl}
        seamless={true}
        loading="lazy"
        title="Bandcamp Player"
      />
    ) : (
      <div class="p-6 text-center">
        <p class="text-muted-foreground mb-4">
          Unable to embed Bandcamp player
        </p>
        <a 
          href={url} 
          target="_blank" 
          rel="noopener noreferrer"
          class="inline-flex items-center px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90 transition-colors"
        >
          Listen on Bandcamp
        </a>
      </div>
    )}
  </div>
  
  <div class="mt-2 text-center">
    <a 
      href={url} 
      target="_blank" 
      rel="noopener noreferrer"
      class="text-xs text-muted-foreground hover:text-foreground transition-colors"
    >
      Open in Bandcamp â†—
    </a>
  </div>
</div>