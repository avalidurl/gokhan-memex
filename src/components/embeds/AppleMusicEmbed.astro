---
interface Props {
  url: string
  width?: string | number
  height?: string | number
  type?: 'song' | 'album' | 'playlist' | 'music-video'
}

const { 
  url, 
  width = '100%', 
  height = '450',
  type = 'song'
} = Astro.props

// Extract Apple Music ID and type from URL
function extractAppleMusicData(url: string): { type: string, id: string, country?: string } | null {
  try {
    // Handle music.apple.com URLs
    const appleMatch = url.match(/music\.apple\.com\/([a-z]{2})\/(album|song|playlist|music-video)\/[^\/]*\/([0-9]+)/i)
    if (appleMatch) {
      return { 
        type: appleMatch[2], 
        id: appleMatch[3],
        country: appleMatch[1] 
      }
    }
    
    // Handle embed.music.apple.com URLs (already embed format)
    const embedMatch = url.match(/embed\.music\.apple\.com\/([a-z]{2})\/(album|song|playlist|music-video)\/[^\/]*\/([0-9]+)/i)
    if (embedMatch) {
      return { 
        type: embedMatch[2], 
        id: embedMatch[3],
        country: embedMatch[1] 
      }
    }
    
    return null
  } catch {
    return null
  }
}

const appleMusicData = extractAppleMusicData(url)
const embedUrl = appleMusicData ? 
  `https://embed.music.apple.com/${appleMusicData.country || 'us'}/${appleMusicData.type}/${appleMusicData.id}` : 
  null
---

<div class="my-6 not-prose">
  <div class="rounded-lg overflow-hidden border bg-card">
    {embedUrl ? (
      <iframe 
        allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write"
        frameborder="0" 
        height={height}
        style={`width: ${width}; max-width: 660px; overflow: hidden; border-radius: 10px;`}
        sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation"
        src={embedUrl}
        loading="lazy"
        title="Apple Music Player"
      >
      </iframe>
    ) : (
      <div class="p-6 text-center">
        <p class="text-muted-foreground mb-4">
          Unable to embed Apple Music player
        </p>
        <a 
          href={url} 
          target="_blank" 
          rel="noopener noreferrer"
          class="inline-flex items-center px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800 transition-colors"
        >
          Open in Apple Music
        </a>
      </div>
    )}
  </div>
  
  <div class="mt-2 text-center">
    <a 
      href={url} 
      target="_blank" 
      rel="noopener noreferrer"
      class="text-xs text-muted-foreground hover:text-foreground transition-colors"
    >
      Open in Apple Music â†—
    </a>
  </div>
</div>