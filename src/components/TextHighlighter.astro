---
// Text Highlighter Component
---

<div id="text-highlighter" class="hidden">
  <!-- Highlight Share Popup -->
  <div id="highlight-popup" 
       class="fixed z-[9999] bg-white dark:bg-gray-900 border-2 border-blue-500 rounded-lg shadow-2xl p-3 transition-all duration-200 transform scale-95 opacity-0"
       style="pointer-events: none; min-width: 200px;">
    
    <!-- Popup Content -->
    <div class="flex items-center gap-2">
      <!-- Share Highlight Label -->
      <span class="text-sm font-medium text-gray-900 dark:text-gray-100 whitespace-nowrap">
        Share highlight
      </span>
      
      <!-- Divider -->
      <div class="w-px h-4 bg-border"></div>
      
      <!-- Social Share Buttons -->
      <div class="flex items-center gap-1">
        <!-- X (Twitter) Button -->
        <button id="share-x" 
                class="flex items-center justify-center w-8 h-8 rounded-md bg-black hover:bg-gray-800 transition-colors group"
                title="Share on X">
          <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </button>
        
        <!-- LinkedIn Button -->
        <button id="share-linkedin" 
                class="flex items-center justify-center w-8 h-8 rounded-md bg-blue-600 hover:bg-blue-700 transition-colors group"
                title="Share on LinkedIn">
          <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
        </button>
      </div>
    </div>
    
    <!-- Popup Arrow -->
    <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-border"></div>
    <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-px w-0 h-0 border-l-4 border-r-4 border-t-4 border-l-transparent border-r-transparent border-t-popover"></div>
  </div>
</div>

<style>
  /* Custom highlight color - light yellow aligned with your palette */
  ::selection {
    background-color: rgb(254 240 138 / 0.6); /* yellow-200 with opacity */
    color: inherit;
  }

  .text-highlight {
    background-color: rgb(254 240 138 / 0.6); /* yellow-200 with opacity */
    border-radius: 3px;
    padding: 1px 2px;
    margin: -1px -2px;
  }

  .dark ::selection {
    background-color: rgb(253 224 71 / 0.4); /* yellow-300 with reduced opacity for dark mode */
  }

  .dark .text-highlight {
    background-color: rgb(253 224 71 / 0.4);
  }
</style>

<script is:inline>
  (function() {
    'use strict';
    
    function TextHighlighter() {
      var self = this;
      self.popup = null;
      self.currentSelection = '';
      self.currentUrl = '';
      self.popupTimeout = null;

      self.init = function() {
        self.popup = document.getElementById('highlight-popup');
        self.currentUrl = window.location.href;
        
        // Listen for text selection
        document.addEventListener('mouseup', self.handleMouseUp);
        document.addEventListener('keyup', self.handleKeyUp);
        
        // Hide popup when clicking elsewhere
        document.addEventListener('click', self.handleDocumentClick);
        
        // Setup share buttons
        self.setupShareButtons();
      };

      self.handleMouseUp = function(event) {
        // Small delay to ensure selection is complete
        setTimeout(function() { self.handleSelection(event); }, 10);
      };

      self.handleKeyUp = function(event) {
        // Handle keyboard selection (Shift + arrow keys, etc.)
        if (event.shiftKey || ['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(event.key)) {
          setTimeout(function() { self.handleSelection(event); }, 10);
        }
      };

      self.handleSelection = function(event) {
        console.log('handleSelection called');
        var selection = window.getSelection();
        if (!selection || selection.isCollapsed) {
          console.log('No selection or collapsed');
          self.hidePopup();
          return;
        }

        var selectedText = selection.toString().trim();
        console.log('Selected text:', selectedText, 'Length:', selectedText.length);
        if (selectedText.length < 10) {
          console.log('Text too short');
          self.hidePopup();
          return;
        }

        // Check if selection is within article content
        var range = selection.getRangeAt(0);
        var container = range.commonAncestorContainer;
        var articleContent = document.querySelector('.prose-content');
        
        console.log('Article content found:', !!articleContent);
        console.log('Container in article:', articleContent && articleContent.contains(container));
        
        if (!articleContent || !articleContent.contains(container)) {
          console.log('Selection not in article content');
          self.hidePopup();
          return;
        }

        self.currentSelection = selectedText;
        console.log('About to show popup');
        self.showPopup(event);
      };

      self.showPopup = function(event) {
        console.log('showPopup called');
        if (!self.popup) {
          console.log('No popup element found!');
          return;
        }

        var selection = window.getSelection();
        if (!selection || !selection.rangeCount) {
          console.log('No selection for popup positioning');
          return;
        }

        var range = selection.getRangeAt(0);
        var rect = range.getBoundingClientRect();
        
        // Position popup above the selection
        var popupX = rect.left + (rect.width / 2);
        var popupY = rect.top - 80; // More space above
        
        // Adjust for viewport boundaries
        var popupWidth = 220;
        var adjustedX = Math.max(10, Math.min(popupX - popupWidth / 2, window.innerWidth - popupWidth - 10));
        
        console.log('Popup position:', { x: adjustedX, y: popupY + window.scrollY });
        
        self.popup.style.left = adjustedX + 'px';
        self.popup.style.top = (popupY + window.scrollY) + 'px';
        self.popup.style.pointerEvents = 'auto';
        
        console.log('About to show popup');
        // Show popup immediately (remove animation complexity)
        self.popup.classList.remove('scale-95', 'opacity-0');
        self.popup.classList.add('scale-100', 'opacity-100');
        console.log('Popup classes updated to visible');
      };

      self.hidePopup = function() {
        if (!self.popup) return;
        
        if (self.popupTimeout) {
          clearTimeout(self.popupTimeout);
        }
        
        self.popup.classList.remove('scale-100', 'opacity-100');
        self.popup.classList.add('scale-95', 'opacity-0');
        self.popup.style.pointerEvents = 'none';
      };

      self.handleDocumentClick = function(event) {
        var target = event.target;
        if (self.popup && !self.popup.contains(target) && !target.closest('#share-x') && !target.closest('#share-linkedin')) {
          self.hidePopup();
        }
      };

      self.setupShareButtons = function() {
        var shareXBtn = document.getElementById('share-x');
        var shareLinkedInBtn = document.getElementById('share-linkedin');

        if (shareXBtn) {
          shareXBtn.addEventListener('click', function() {
            self.shareOnX();
          });
        }

        if (shareLinkedInBtn) {
          shareLinkedInBtn.addEventListener('click', function() {
            self.shareOnLinkedIn();
          });
        }
      };

      self.shareOnX = function() {
        var text = '"' + self.currentSelection + '"\n\n' + self.currentUrl;
        var url = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(text);
        window.open(url, '_blank', 'noopener,noreferrer');
        self.hidePopup();
      };

      self.shareOnLinkedIn = function() {
        var url = 'https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(self.currentUrl);
        window.open(url, '_blank', 'noopener,noreferrer');
        self.hidePopup();
      };

      // Don't initialize immediately - wait for DOM
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() { 
        var highlighter = new TextHighlighter();
        highlighter.init();
      });
    } else {
      var highlighter = new TextHighlighter();
      highlighter.init();
    }
  })();
</script>