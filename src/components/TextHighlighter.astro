---
// Text Highlighter Component with Share Popup
---

<div id="text-highlighter" class="hidden">
  <!-- Highlight Share Popup -->
  <div id="highlight-popup" 
       class="fixed z-[9999] bg-white dark:bg-gray-900 border-2 border-blue-500 rounded-lg shadow-2xl p-3 transition-all duration-200 transform scale-95 opacity-0"
       style="pointer-events: none; min-width: 200px;">
    
    <!-- Popup Content -->
    <div class="flex items-center gap-2">
      <!-- Share Highlight Label -->
      <span class="text-sm font-medium text-gray-900 dark:text-gray-100 whitespace-nowrap">
        Share highlight
      </span>
      
      <!-- Divider -->
      <div class="w-px h-4 bg-border"></div>
      
      <!-- Social Share Buttons -->
      <div class="flex items-center gap-1">
        <!-- X (Twitter) Button -->
        <button id="share-x" 
                class="flex items-center justify-center w-8 h-8 rounded-md bg-black hover:bg-gray-800 transition-colors group"
                title="Share on X">
          <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </button>
        
        <!-- LinkedIn Button -->
        <button id="share-linkedin" 
                class="flex items-center justify-center w-8 h-8 rounded-md bg-blue-600 hover:bg-blue-700 transition-colors group"
                title="Share on LinkedIn">
          <svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Highlight styles */
  .highlight {
    background-color: hsl(var(--accent) / 0.3);
    padding: 2px 4px;
    border-radius: 3px;
    transition: background-color 0.2s ease;
  }
  
  .highlight:hover {
    background-color: hsl(var(--accent) / 0.4);
  }
</style>

<script is:inline>
  class TextHighlighter {
    constructor() {
      this.isHighlighting = false;
      this.selectedText = '';
      this.popup = null;
      this.shareXBtn = null;
      this.shareLinkedInBtn = null;
      
      this.init();
    }
    
    init() {
      // Wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.setup());
      } else {
        this.setup();
      }
    }
    
    setup() {
      this.popup = document.getElementById('highlight-popup');
      this.shareXBtn = document.getElementById('share-x');
      this.shareLinkedInBtn = document.getElementById('share-linkedin');
      
      if (!this.popup || !this.shareXBtn || !this.shareLinkedInBtn) return;
      
      // Add event listeners
      document.addEventListener('mouseup', (e) => this.handleSelection(e));
      document.addEventListener('mousedown', () => this.hidePopup());
      
      // Share button events
      this.shareXBtn.addEventListener('click', () => this.shareToX());
      this.shareLinkedInBtn.addEventListener('click', () => this.shareToLinkedIn());
      
      // Hide popup when clicking outside
      document.addEventListener('click', (e) => {
        if (!this.popup.contains(e.target)) {
          this.hidePopup();
        }
      });
    }
    
    handleSelection(e) {
      const selection = window.getSelection();
      if (!selection) return;
      
      const text = selection.toString().trim();
      
      if (text.length > 0) {
        this.selectedText = text;
        this.showPopup(e);
        this.highlightSelection();
      } else {
        this.hidePopup();
      }
    }
    
    highlightSelection() {
      const selection = window.getSelection();
      if (!selection || selection.rangeCount === 0) return;
      
      const range = selection.getRangeAt(0);
      const span = document.createElement('span');
      span.className = 'highlight';
      
      try {
        range.surroundContents(span);
        selection.removeAllRanges();
      } catch (e) {
        // If surroundContents fails, try a different approach
        const contents = range.extractContents();
        span.appendChild(contents);
        range.insertNode(span);
      }
    }
    
    showPopup(e) {
      if (!this.popup) return;
      
      const rect = e.target.getBoundingClientRect();
      const popupRect = this.popup.getBoundingClientRect();
      
      // Position popup above the selection
      const x = e.clientX - (popupRect.width / 2);
      const y = rect.top - popupRect.height - 10;
      
      this.popup.style.left = `${Math.max(10, Math.min(x, window.innerWidth - popupRect.width - 10))}px`;
      this.popup.style.top = `${Math.max(10, y)}px`;
      this.popup.style.pointerEvents = 'auto';
      this.popup.style.transform = 'scale(1)';
      this.popup.style.opacity = '1';
    }
    
    hidePopup() {
      if (!this.popup) return;
      
      this.popup.style.pointerEvents = 'none';
      this.popup.style.transform = 'scale(0.95)';
      this.popup.style.opacity = '0';
    }
    
    shareToX() {
      const url = window.location.href;
      const text = this.selectedText;
      const shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(`"${text}"`)}&url=${encodeURIComponent(url)}`;
      window.open(shareUrl, '_blank', 'width=550,height=420');
      this.hidePopup();
    }
    
    shareToLinkedIn() {
      const url = window.location.href;
      const text = this.selectedText;
      const shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}&summary=${encodeURIComponent(text)}`;
      window.open(shareUrl, '_blank', 'width=550,height=420');
      this.hidePopup();
    }
  }
  
  // Initialize the text highlighter
  new TextHighlighter();
</script>