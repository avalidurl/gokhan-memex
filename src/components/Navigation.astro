---
import { Menu, X, Search } from 'lucide-astro'
import ThemeToggle from './ThemeToggle.astro'
import SearchComponent from './Search.astro'

const currentPath = Astro.url.pathname
const isArticle = currentPath.startsWith('/journal/') && currentPath !== '/journal/' && currentPath !== '/journal'

const navigation = [
  { name: 'Journal', href: '/journal' },
  { name: 'Archive', href: '/archive' },
  { name: 'Lists', href: '/lists' },
  { name: 'Contact', href: '/subscribe' }
]
---

<header id="site-header" class="sticky top-0 z-50 w-full border-b border-border bg-background/95 backdrop-blur-sm supports-[backdrop-filter]:bg-background/80 transition-transform duration-200">
  <div class="eink-wrap">
    <div class="flex min-h-[56px] items-center justify-between gap-4">
      <!-- Left side: Logo/Name or Back button -->
      <div class="flex items-center">
        {isArticle ? (
          <a 
            href="/journal" 
            class="flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors"
            aria-label="Back to Journal"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
            <span class="text-sm font-medium hidden sm:inline">Close</span>
          </a>
        ) : (
          <a 
            class="eink-ui text-base font-bold tracking-[-0.02em] text-foreground hover:text-foreground/80 transition-colors"
            href="/"
          >
            GÃ¶khan Turhan
          </a>
        )}
      </div>

      <!-- Center: Navigation Links (Desktop only, not on article pages) -->
      {!isArticle && (
        <nav class="eink-ui hidden md:flex items-center gap-4 text-[0.95rem]">
          {navigation.map((item) => (
            <a
              href={item.href}
              class={`transition-colors ${
                currentPath === item.href || currentPath.startsWith(item.href + '/')
                  ? 'text-foreground font-medium' 
                  : 'text-muted-foreground hover:text-foreground'
              }`}
            >
              {item.name}
            </a>
          ))}
        </nav>
      )}

      <!-- Right side: Actions -->
      <div class="flex items-center gap-2">
        <!-- Search Button -->
        <button 
          id="search-button"
          class="flex min-h-[44px] min-w-[44px] items-center justify-center rounded-full border border-border bg-card text-muted-foreground transition-colors hover:bg-muted/50 hover:text-foreground"
          aria-label="Search"
        >
          <Search class="h-4 w-4" />
        </button>
        
        <!-- Theme Toggle -->
        <ThemeToggle />

        <!-- Mobile Menu Button (not on article pages) -->
        {!isArticle && (
          <button 
            class="md:hidden flex min-h-[44px] min-w-[44px] items-center justify-center rounded-full border border-border bg-card text-muted-foreground transition-colors hover:bg-muted/50 hover:text-foreground"
            id="mobile-menu-button"
            aria-label="Toggle menu"
          >
            <Menu class="h-5 w-5" id="menu-icon" />
            <X class="h-5 w-5 hidden" id="close-icon" />
          </button>
        )}
      </div>
    </div>
  </div>

</header>

<!-- Mobile Navigation Overlay - Outside header for proper stacking -->
<div class="md:hidden hidden fixed inset-x-0 top-14 bottom-0 bg-background z-50 overflow-y-auto border-t border-border" id="mobile-menu">
  <nav class="eink-ui flex flex-col px-6 py-6">
    {navigation.map((item) => (
      <a
        href={item.href}
        class={`py-4 text-xl border-b border-border/30 transition-colors ${
          currentPath === item.href || currentPath.startsWith(item.href + '/')
            ? 'text-foreground font-medium' 
            : 'text-muted-foreground hover:text-foreground'
        }`}
      >
        {item.name}
      </a>
    ))}
    <a 
      href="/rss.xml" 
      class="py-4 text-xl text-muted-foreground hover:text-foreground transition-colors"
    >
      RSS Feed
    </a>
  </nav>
</div>

<!-- Search Modal -->
<SearchComponent />

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('mobile-menu-button')
    const menu = document.getElementById('mobile-menu')
    const menuIcon = document.getElementById('menu-icon')
    const closeIcon = document.getElementById('close-icon')
    const siteHeader = document.getElementById('site-header')
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    let lastScrollY = window.scrollY
    let isHeaderHidden = false

    button?.addEventListener('click', () => {
      const isHidden = menu?.classList.contains('hidden')
      
      if (isHidden) {
        menu?.classList.remove('hidden')
        menuIcon?.classList.add('hidden')
        closeIcon?.classList.remove('hidden')
        document.body.style.overflow = 'hidden'
      } else {
        menu?.classList.add('hidden')
        menuIcon?.classList.remove('hidden')
        closeIcon?.classList.add('hidden')
        document.body.style.overflow = ''
      }
    })

    // Close menu on navigation
    const menuLinks = menu?.querySelectorAll('a')
    menuLinks?.forEach(link => {
      link.addEventListener('click', () => {
        menu?.classList.add('hidden')
        menuIcon?.classList.remove('hidden')
        closeIcon?.classList.add('hidden')
        document.body.style.overflow = ''
      })
    })

    const onScroll = () => {
      if (prefersReducedMotion) return
      if (!siteHeader || (menu && !menu.classList.contains('hidden'))) return

      const currentY = window.scrollY
      const delta = currentY - lastScrollY

      if (currentY > 80 && delta > 4 && !isHeaderHidden) {
        siteHeader.style.transform = 'translateY(-100%)'
        isHeaderHidden = true
      } else if (delta < -4 && isHeaderHidden) {
        siteHeader.style.transform = 'translateY(0)'
        isHeaderHidden = false
      }

      lastScrollY = currentY
    }

    window.addEventListener('scroll', onScroll, { passive: true })
  })
</script>
