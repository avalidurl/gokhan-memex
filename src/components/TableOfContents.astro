---
export interface Props {
  headings: Array<{
    depth: number
    slug: string
    text: string
  }>
}

const { headings } = Astro.props

// Filter to only include h2 and h3 headings for cleaner TOC
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3)
---

{tocHeadings.length > 0 && (
  <nav class="toc-container" aria-label="Table of contents">
    <div class="toc-header">
      <span class="text-xs font-medium uppercase tracking-wider text-muted-foreground">Contents</span>
    </div>
    <ul class="toc-list">
      {tocHeadings.map((heading) => (
        <li 
          class={`toc-item ${heading.depth === 3 ? 'toc-item-nested' : ''}`}
          data-heading={heading.slug}
        >
          <a 
            href={`#${heading.slug}`}
            class="toc-link"
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  </nav>
)}

<style>
  .toc-container {
    position: sticky;
    top: 5rem;
    max-height: calc(100vh - 6rem);
    overflow-y: auto;
    padding-right: 1rem;
    scrollbar-width: thin;
  }

  .toc-container::-webkit-scrollbar {
    width: 4px;
  }

  .toc-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-container::-webkit-scrollbar-thumb {
    background: hsl(var(--border));
    border-radius: 2px;
  }

  .toc-header {
    padding-bottom: 0.75rem;
    margin-bottom: 0.75rem;
    border-bottom: 1px solid hsl(var(--border));
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .toc-item {
    line-height: 1.4;
  }

  .toc-item-nested {
    padding-left: 1rem;
  }

  .toc-link {
    display: block;
    padding: 0.375rem 0;
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
    text-decoration: none;
    transition: color 0.15s ease;
    border-left: 2px solid transparent;
    padding-left: 0.75rem;
    margin-left: -0.75rem;
  }

  .toc-link:hover {
    color: hsl(var(--foreground));
  }

  .toc-item.active .toc-link {
    color: hsl(var(--foreground));
    border-left-color: hsl(var(--foreground));
    font-weight: 500;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tocItems = document.querySelectorAll('.toc-item')
    const headings = document.querySelectorAll('h2[id], h3[id]')
    
    if (tocItems.length === 0 || headings.length === 0) return

    const observerOptions = {
      rootMargin: '-80px 0px -70% 0px',
      threshold: 0
    }

    let currentActive: string | null = null

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const id = entry.target.getAttribute('id')
          if (id && id !== currentActive) {
            currentActive = id
            tocItems.forEach((item) => {
              const itemHeading = item.getAttribute('data-heading')
              if (itemHeading === id) {
                item.classList.add('active')
              } else {
                item.classList.remove('active')
              }
            })
          }
        }
      })
    }, observerOptions)

    headings.forEach((heading) => {
      observer.observe(heading)
    })

    // Smooth scroll on click
    tocItems.forEach((item) => {
      const link = item.querySelector('a')
      link?.addEventListener('click', (e) => {
        e.preventDefault()
        const targetId = link.getAttribute('href')?.slice(1)
        const target = document.getElementById(targetId || '')
        if (target) {
          const offset = 100
          const targetPosition = target.getBoundingClientRect().top + window.scrollY - offset
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          })
        }
      })
    })
  })
</script>

